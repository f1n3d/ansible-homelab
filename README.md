# Ansible Homelab - LXC Container Management

Ansible repository for automated management of LXC containers on a Proxmox host. Focused on security, automation, and Docker-based services with centralized OIDC authentication.

## Features

- **Hardened security baseline** - SSH hardening, Fail2Ban, kernel hardening, auto-updates, session hardening
- **Modular services** - Pick only what you need
- **Interactive setup** - `setup.sh` configures everything for your infrastructure
- **Centralized logging** - Loki + Grafana + Alloy with pre-built dashboards
- **OIDC/SSO** - Centralized authentication via Authentik
- **Encrypted secrets** - All credentials stored with Ansible Vault

## Available Services

| Service | Description | Default Port |
|---------|-------------|-------------|
| **Paperless-NGX** | Document management with OCR | 8000 |
| **Docmost** | Documentation / Wiki platform | 3000 |
| **Authentik** | Identity Provider (OIDC/SSO) | 9000 |
| **Website** | Hardened nginx + contact form + Postfix | 80 |
| **Cloudflared** | Cloudflare Tunnel for external access | - |
| **Samba** | Network file sharing (SMB) | 445 |
| **Logging** | Loki + Grafana (centralized logging) | 3000/3100 |

## Architecture

```
Internet
    |
Cloudflare Tunnel (TLS, DDoS, WAF)
    |
Proxmox Host
    |
+-- LXC Container (per service)
    +-- Docker Compose (application)
    +-- Grafana Alloy (log shipper)
    +-- Hardened Baseline
```

Each container goes through a security baseline before any services are deployed. Authentik serves as the central identity provider with OIDC integration for all services.

## Prerequisites

- **Proxmox host** with LXC containers running Debian or Ubuntu
- **SSH key access** to all containers (as root)
- **Ansible >= 2.15** on your control machine
- **Python 3** on all hosts
- **openssl** (for password generation during setup)

## Quick Start

```bash
# 1. Clone this repository
git clone <repo-url> ansible-homelab
cd ansible-homelab

# 2. Run the interactive setup
./setup.sh

# 3. Copy your SSH key to each server
ssh-copy-id root@<server-ip>

# 4. Test connectivity
ansible lxc_containers -m ping

# 5. Deploy the security baseline (required first!)
ansible-playbook playbooks/baseline.yml

# 6. Deploy all selected services
ansible-playbook playbooks/deploy_all.yml
```

The setup script will:
- Ask which services you want to deploy
- Collect IP addresses, domains, and credentials
- Auto-generate secure passwords (with option to override)
- Create and encrypt vault files
- Remove unselected services from the repository
- Generate a customized inventory

## Repository Structure

```
.
├── setup.sh                    # Interactive setup script
├── ansible.cfg                 # Ansible configuration
├── inventory/
│   ├── hosts.yml              # Host inventory (generated by setup.sh)
│   └── group_vars/
│       ├── all.yml            # Global variables
│       └── <service>/
│           ├── vault.yml          # Encrypted secrets (generated)
│           └── vault.yml.example  # Template for secrets
├── playbooks/
│   ├── baseline.yml           # Security baseline (run first!)
│   ├── deploy_all.yml         # Deploy all services
│   ├── <service>.yml          # Per-service playbooks
│   └── diagnose-logging.yml   # Logging stack diagnostics
└── roles/
    ├── baseline/              # Security hardening + Alloy log shipper
    ├── paperless/             # Paperless-NGX
    ├── docmost/               # Docmost
    ├── authentik/             # Authentik Identity Provider
    ├── website/               # nginx + Contact-API + Postfix
    ├── cloudflared/           # Cloudflare Tunnel
    ├── samba/                 # Samba file server
    └── logging/               # Loki + Grafana + dashboards
```

## Security Baseline

The baseline playbook (`playbooks/baseline.yml`) hardens every container with:

- **SSH**: Key-only auth, modern ciphers, max 3 auth tries, login banner
- **Fail2Ban**: 3 attempts = 24h ban
- **Kernel hardening**: TCP SYN cookies, RP filter, IPv6 disabled, no ICMP redirects
- **Docker hardening**: no-new-privileges, log rotation
- **Session hardening**: 15min timeout, umask 027, strong password hashing
- **Auto-updates**: Weekly security updates (Sunday 03:00)
- **Cleanup**: Removes unnecessary packages (gcc, make, telnet, ftp, etc.)

## Centralized Logging

**Stack:** Grafana Alloy (log shipper) -> Loki (storage) -> Grafana (visualization)

- 11 pre-built dashboards (system overview, security, per-service)
- Automatic log categorization via relabel rules
- 30-day retention
- Deploy: `ansible-playbook playbooks/logging.yml`
- Enable log shipping: `ansible-playbook playbooks/baseline.yml --tags alloy`

## Manual Configuration

If you prefer not to use `setup.sh`:

1. Copy `inventory/group_vars/<service>/vault.yml.example` to `vault.yml`
2. Fill in your values
3. Encrypt: `ansible-vault encrypt inventory/group_vars/<service>/vault.yml`
4. Edit `inventory/hosts.yml` with your IPs
5. Edit `roles/<service>/defaults/main.yml` for service-specific settings
6. Create `~/.vault_pass` with your vault password

## Common Commands

```bash
# Syntax check
ansible-playbook --syntax-check playbooks/<service>.yml

# Dry run
ansible-playbook --check playbooks/<service>.yml

# Deploy a single service
ansible-playbook playbooks/<service>.yml

# Deploy everything
ansible-playbook playbooks/deploy_all.yml

# Edit secrets
ansible-vault edit inventory/group_vars/<service>/vault.yml

# Test connectivity
ansible lxc_containers -m ping

# Re-run setup with previous answers
./setup.sh --reconfigure
```

## Troubleshooting

**Vault password missing:**
```
ERROR! Vault password file not found: ~/.vault_pass
```
Create the file: `echo "your-password" > ~/.vault_pass && chmod 600 ~/.vault_pass`

**Docker not installed:**
Run the baseline first: `ansible-playbook playbooks/baseline.yml`

**Connection refused:**
Ensure SSH key is copied: `ssh-copy-id root@<server-ip>`

**Logging diagnostics:**
```bash
ansible-playbook playbooks/diagnose-logging.yml
```

## License

MIT
