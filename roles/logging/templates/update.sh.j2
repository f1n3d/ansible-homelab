#!/bin/bash
# =============================================================================
# Logging Stack Update Script (Loki + Grafana)
# =============================================================================
# Auto-generated by Ansible - roles/logging
# Automatische Versionserkennung via GitHub Releases API
#
# Cron: {{ logging_update_weekday }} {{ logging_update_hour }}:{{ logging_update_minute }}

set -euo pipefail

# =============================================================================
# Configuration
# =============================================================================
LOG_FILE="{{ logging_install_path }}/update.log"
COMPOSE_FILE="{{ logging_install_path }}/docker-compose.yml"
COMPOSE_BACKUP="{{ logging_install_path }}/docker-compose.yml.bak"

LOKI_REPO="grafana/loki"
GRAFANA_REPO="grafana/grafana"

# Fallback-Versionen (falls GitHub API fehlschlägt)
LOKI_FALLBACK="{{ loki_fallback_version }}"
GRAFANA_FALLBACK="{{ grafana_fallback_version }}"

# =============================================================================
# Functions
# =============================================================================
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

get_latest_version() {
    local repo="$1"
    local version

    # GitHub Releases API abfragen (ohne Auth - Public Repo)
    version=$(curl -s "https://api.github.com/repos/${repo}/releases/latest" \
        | grep '"tag_name"' \
        | sed -E 's/.*"tag_name": "v?([^"]+)".*/\1/' \
        | head -1)

    # Validierung: Version muss Format X.Y.Z haben
    if [[ "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo "$version"
    else
        echo ""
    fi
}

get_current_version() {
    local service="$1"
    local current

    current=$(grep "image: ${service}:" "$COMPOSE_FILE" \
        | head -1 \
        | sed -E 's/.*:([0-9.]+).*/\1/')

    echo "$current"
}

update_compose_version() {
    local service="$1"
    local new_version="$2"

    # Backup erstellen
    cp "$COMPOSE_FILE" "$COMPOSE_BACKUP"

    # Alle Vorkommen der Service-Version aktualisieren
    sed -i.tmp "s|image: ${service}:[0-9.]*|image: ${service}:${new_version}|g" "$COMPOSE_FILE"
    rm -f "${COMPOSE_FILE}.tmp"

    log "[SUCCESS] Updated ${service} to version ${new_version} in docker-compose.yml"
}

# =============================================================================
# Main Update Logic
# =============================================================================
log "========================================"
log "Logging Stack Update START"
log "========================================"

cd "{{ logging_install_path }}"

# -----------------------------------------------------------------------------
# 1. Loki Version Check
# -----------------------------------------------------------------------------
log "[INFO] Checking Loki version..."
LOKI_CURRENT=$(get_current_version "{{ loki_image_base }}")
LOKI_LATEST=$(get_latest_version "$LOKI_REPO")

if [ -z "$LOKI_LATEST" ]; then
    log "[WARN] Could not fetch Loki version from GitHub API, using fallback: ${LOKI_FALLBACK}"
    LOKI_LATEST="$LOKI_FALLBACK"
fi

log "[INFO] Loki - Current: ${LOKI_CURRENT}, Latest: ${LOKI_LATEST}"

if [ "$LOKI_CURRENT" != "$LOKI_LATEST" ]; then
    log "[INFO] Loki update available: ${LOKI_CURRENT} → ${LOKI_LATEST}"
    update_compose_version "{{ loki_image_base }}" "$LOKI_LATEST"
    LOKI_UPDATED=true
else
    log "[INFO] Loki is already at latest version: ${LOKI_CURRENT}"
    LOKI_UPDATED=false
fi

# -----------------------------------------------------------------------------
# 2. Grafana Version Check
# -----------------------------------------------------------------------------
log "[INFO] Checking Grafana version..."
GRAFANA_CURRENT=$(get_current_version "{{ grafana_image_base }}")
GRAFANA_LATEST=$(get_latest_version "$GRAFANA_REPO")

if [ -z "$GRAFANA_LATEST" ]; then
    log "[WARN] Could not fetch Grafana version from GitHub API, using fallback: ${GRAFANA_FALLBACK}"
    GRAFANA_LATEST="$GRAFANA_FALLBACK"
fi

log "[INFO] Grafana - Current: ${GRAFANA_CURRENT}, Latest: ${GRAFANA_LATEST}"

if [ "$GRAFANA_CURRENT" != "$GRAFANA_LATEST" ]; then
    log "[INFO] Grafana update available: ${GRAFANA_CURRENT} → ${GRAFANA_LATEST}"
    update_compose_version "{{ grafana_image_base }}" "$GRAFANA_LATEST"
    GRAFANA_UPDATED=true
else
    log "[INFO] Grafana is already at latest version: ${GRAFANA_CURRENT}"
    GRAFANA_UPDATED=false
fi

# -----------------------------------------------------------------------------
# 3. Pull Latest Images
# -----------------------------------------------------------------------------
if [ "$LOKI_UPDATED" = true ] || [ "$GRAFANA_UPDATED" = true ]; then
    log "[INFO] Pulling latest images..."
    docker compose pull 2>&1 | tee -a "$LOG_FILE"
else
    log "[INFO] No updates available, checking for image updates anyway..."
    docker compose pull 2>&1 | tee -a "$LOG_FILE"
fi

# -----------------------------------------------------------------------------
# 4. Restart Containers
# -----------------------------------------------------------------------------
log "[INFO] Restarting containers with new images..."
docker compose up -d 2>&1 | tee -a "$LOG_FILE"

# Wait for services to become healthy
log "[INFO] Waiting for services to become healthy..."
sleep 15

# -----------------------------------------------------------------------------
# 5. Health Checks
# -----------------------------------------------------------------------------
log "[INFO] Checking container health..."

# Loki Health Check
if docker ps | grep -q loki; then
    LOKI_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:{{ loki_http_port }}/ready || echo "000")
    if [ "$LOKI_HEALTH" = "200" ]; then
        log "[SUCCESS] Loki is running and healthy"
    else
        log "[ERROR] Loki is running but not healthy (HTTP ${LOKI_HEALTH})"
        exit 1
    fi
else
    log "[ERROR] Loki container is not running!"
    exit 1
fi

# Grafana Health Check
if docker ps | grep -q grafana; then
    GRAFANA_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:{{ grafana_http_port }}/api/health || echo "000")
    if [ "$GRAFANA_HEALTH" = "200" ]; then
        log "[SUCCESS] Grafana is running and healthy"
    else
        log "[ERROR] Grafana is running but not healthy (HTTP ${GRAFANA_HEALTH})"
        exit 1
    fi
else
    log "[ERROR] Grafana container is not running!"
    exit 1
fi

# -----------------------------------------------------------------------------
# 6. Cleanup
# -----------------------------------------------------------------------------
log "[INFO] Cleaning up old images..."
docker image prune -f 2>&1 | tee -a "$LOG_FILE"

# Remove old backup if everything is okay
if [ -f "$COMPOSE_BACKUP" ]; then
    rm -f "$COMPOSE_BACKUP"
fi

# -----------------------------------------------------------------------------
# 7. Summary
# -----------------------------------------------------------------------------
log "========================================"
log "Logging Stack Update COMPLETE"
if [ "$LOKI_UPDATED" = true ]; then
    log "  - Loki: ${LOKI_CURRENT} → ${LOKI_LATEST}"
fi
if [ "$GRAFANA_UPDATED" = true ]; then
    log "  - Grafana: ${GRAFANA_CURRENT} → ${GRAFANA_LATEST}"
fi
log "========================================"

exit 0
