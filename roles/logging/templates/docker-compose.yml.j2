# =============================================================================
# Logging Stack - Docker Compose
# =============================================================================
# Auto-generated by Ansible - roles/logging
# Do not edit manually - changes will be overwritten
#
# Services: Loki + Grafana
# Stack: chronicle ({{ ansible_host }})

services:
  loki:
    image: {{ loki_image_base }}:{{ loki_version }}
    container_name: loki
    restart: unless-stopped
    ports:
      - "{{ loki_http_port }}:3100"
      - "{{ loki_grpc_port }}:9096"
    volumes:
      - {{ loki_data_path }}/loki-config.yml:/etc/loki/loki-config.yml:ro
      - {{ loki_data_path }}/index:/var/lib/loki/index
      - {{ loki_data_path }}/cache:/var/lib/loki/cache
      - {{ loki_data_path }}/chunks:/var/lib/loki/chunks
      - {{ loki_data_path }}/compactor:/var/lib/loki/compactor
      - {{ loki_data_path }}/rules:/var/lib/loki/rules
      - {{ loki_data_path }}/rules-temp:/var/lib/loki/rules-temp
      - {{ loki_data_path }}/wal:/var/lib/loki/wal
    command: -config.file=/etc/loki/loki-config.yml
    networks:
      - logging
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: {{ loki_memory_limit }}
          cpus: '{{ loki_cpu_limit }}'
    # No built-in healthcheck - Loki image lacks curl/wget
    # Health is verified by Ansible after deployment

  grafana:
    image: {{ grafana_image_base }}:{{ grafana_version }}
    container_name: grafana
    restart: unless-stopped
    ports:
      - "{{ grafana_http_port }}:3000"
    volumes:
      - {{ grafana_data_path }}/grafana.ini:/etc/grafana/grafana.ini:ro
      - {{ grafana_data_path }}/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - {{ grafana_data_path }}/dashboard-provider.yml:/etc/grafana/provisioning/dashboards/provider.yml:ro
      - {{ grafana_data_path }}/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER={{ grafana_admin_user }}
      - GF_SECURITY_ADMIN_PASSWORD={{ grafana_admin_password }}
      - GF_SERVER_ROOT_URL=https://{{ grafana_domain }}
{% if grafana_oidc_enabled %}
      - GF_AUTH_GENERIC_OAUTH_CLIENT_ID={{ grafana_oidc_client_id }}
      - GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET={{ grafana_oidc_client_secret }}
{% endif %}
    depends_on:
      - loki
    networks:
      - logging
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: {{ grafana_memory_limit }}
          cpus: '{{ grafana_cpu_limit }}'
    # No built-in healthcheck - verified by Ansible after deployment

networks:
  logging:
    driver: bridge

volumes:
  grafana_data:
    driver: local
