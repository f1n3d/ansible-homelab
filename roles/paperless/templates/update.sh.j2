#!/bin/bash
# {{ ansible_managed }}
# Paperless-NGX Container Update Script
# Mit PostgreSQL-Backup und Graceful Shutdown

set -e

INSTALL_PATH="{{ paperless_install_path }}"
BACKUP_DIR="{{ paperless_install_path }}/backups"
LOGFILE="{{ paperless_install_path }}/update.log"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_RETENTION_DAYS=7

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOGFILE"
}

log "=== Starting Paperless update ==="

cd "$INSTALL_PATH"

# Backup-Verzeichnis erstellen falls nicht vorhanden
mkdir -p "$BACKUP_DIR"

# 1. PostgreSQL Backup erstellen
log "Creating PostgreSQL backup..."
if docker compose exec -T db pg_dump -U {{ paperless_postgres_user }} {{ paperless_postgres_db }} > "$BACKUP_DIR/paperless_db_$DATE.sql" 2>/dev/null; then
    gzip "$BACKUP_DIR/paperless_db_$DATE.sql"
    log "Database backup created: paperless_db_$DATE.sql.gz"
else
    log "WARNING: Database backup failed, but continuing with update..."
fi

# 2. Alte Backups aufräumen (älter als BACKUP_RETENTION_DAYS Tage)
log "Cleaning up old backups..."
find "$BACKUP_DIR" -name "paperless_db_*.sql.gz" -mtime +$BACKUP_RETENTION_DAYS -delete 2>/dev/null || true

# 3. Neue Images pullen (bevor wir stoppen, um Downtime zu minimieren)
log "Pulling new Docker images..."
docker compose pull

# 4. Graceful Shutdown der Services
log "Stopping services gracefully..."
# Erst Webserver stoppen, dann Hilfsdienste, dann Datenbanken
docker compose stop webserver || true
docker compose stop gotenberg tika || true
docker compose stop broker || true
docker compose stop db || true

# 5. Kurz warten, damit alle Prozesse sauber beendet werden
sleep 5

# 6. Alle Container neu starten
log "Starting updated containers..."
docker compose up -d --remove-orphans

# 7. Warten auf Health-Check
log "Waiting for services to become healthy..."
RETRIES=30
COUNT=0
while [ $COUNT -lt $RETRIES ]; do
    if curl -sf "http://localhost:{{ paperless_port }}" > /dev/null 2>&1; then
        log "Paperless is healthy and responding"
        break
    fi
    COUNT=$((COUNT + 1))
    log "Waiting for Paperless to start... ($COUNT/$RETRIES)"
    sleep 10
done

if [ $COUNT -eq $RETRIES ]; then
    log "WARNING: Paperless health check timed out after $((RETRIES * 10)) seconds"
fi

# 8. Aufräumen alter Docker Images
log "Cleaning up unused Docker images..."
docker image prune -f > /dev/null 2>&1 || true

log "=== Paperless update completed ==="
