// =============================================================================
// Grafana Alloy Configuration - System & Application Logs
// =============================================================================
// Auto-generated by Ansible - roles/baseline
// Do not edit manually - changes will be overwritten
//
// Host: {{ inventory_hostname }} ({{ ansible_host }})
// Loki Endpoint: {{ loki_push_endpoint }}

// ========== Loki Backend Configuration ==========
loki.write "loki_backend" {
  endpoint {
    url = "{{ loki_push_endpoint }}"
  }

  external_labels = {
    "host"        = "{{ inventory_hostname }}",
    "environment" = "production",
  }
}

// ========== Systemd Journal Logs ==========
loki.source.journal "system_journal" {
  max_age    = "12h"
  path       = "/var/log/journal"
  labels     = {
    host        = "{{ inventory_hostname }}",
    environment = "production",
  }
  relabel_rules = loki.relabel.journal_relabel.rules
  forward_to    = [loki.write.loki_backend.receiver]
}

loki.relabel "journal_relabel" {
  forward_to = []

  // Step 1: Set default job="syslog" for ALL journal entries first.
  // Alloy sets job="loki.source.journal.system_journal" by default,
  // so we override it unconditionally, then let specific rules below
  // override again for auth/kernel.
  rule {
    source_labels = ["__journal__systemd_unit"]
    regex         = ".+"
    target_label  = "job"
    replacement   = "syslog"
  }

  // Catch entries without systemd_unit (also set to syslog)
  rule {
    source_labels = ["__journal__systemd_unit"]
    regex         = "^$"
    target_label  = "job"
    replacement   = "syslog"
  }

  // Step 2: Override with specific job labels where applicable
  // Auth-related services (sshd, sudo, fail2ban) -> job="auth"
  rule {
    source_labels = ["__journal__systemd_unit"]
    regex         = "(sshd|ssh|fail2ban|sudo)\\.service"
    target_label  = "job"
    replacement   = "auth"
  }

  // Also catch auth by syslog_identifier (covers cases where
  // systemd_unit is different but the process is auth-related)
  rule {
    source_labels = ["__journal_syslog_identifier"]
    regex         = "(sshd|sshd-session|sudo|fail2ban-server|fail2ban-client).*"
    target_label  = "job"
    replacement   = "auth"
  }

  // Kernel messages -> job="kernel" (only on non-LXC hosts)
  rule {
    source_labels = ["__journal__transport"]
    regex         = "kernel"
    target_label  = "job"
    replacement   = "kernel"
  }

  // Step 3: Preserve original metadata as labels
  rule {
    source_labels = ["__journal__systemd_unit"]
    target_label  = "unit"
  }

  rule {
    source_labels = ["__journal_priority"]
    target_label  = "priority"
  }

  rule {
    source_labels = ["__journal_syslog_identifier"]
    target_label  = "syslog_identifier"
  }
}

// ========== Docker Container Logs ==========
discovery.docker "docker_containers" {
  host             = "unix:///var/run/docker.sock"
  refresh_interval = "60s"
}

loki.relabel "docker_relabel" {
  forward_to = []

  // Step 1: Extract container metadata
  rule {
    source_labels = ["__meta_docker_container_name"]
    regex         = "/(.*)"
    target_label  = "container"
  }

  rule {
    source_labels = ["__meta_docker_container_id"]
    target_label  = "container_id"
  }

  // Step 2: App-specific job labels (override static job="docker")
  // Rules are evaluated in order - first match wins, later rules override.
  // Container names: paperless-webserver-1, paperless-db-1, etc.

  // Paperless (webserver, db, broker, gotenberg, tika)
  rule {
    source_labels = ["__meta_docker_container_name"]
    regex         = "/paperless.*"
    target_label  = "job"
    replacement   = "paperless"
  }

  // Authentik (server, worker, postgresql, redis)
  rule {
    source_labels = ["__meta_docker_container_name"]
    regex         = "/authentik.*"
    target_label  = "job"
    replacement   = "authentik"
  }

  // Docmost (docmost, docmost-db, docmost-redis)
  rule {
    source_labels = ["__meta_docker_container_name"]
    regex         = "/docmost.*"
    target_label  = "job"
    replacement   = "docmost"
  }

  // Samba
  rule {
    source_labels = ["__meta_docker_container_name"]
    regex         = "/samba"
    target_label  = "job"
    replacement   = "samba"
  }

  // Cloudflared
  rule {
    source_labels = ["__meta_docker_container_name"]
    regex         = "/cloudflared"
    target_label  = "job"
    replacement   = "cloudflared"
  }

  // Website (nginx)
  rule {
    source_labels = ["__meta_docker_container_name"]
    regex         = "/nginx"
    target_label  = "job"
    replacement   = "website"
  }

  // Logging stack (loki, grafana on chronicle-server)
  rule {
    source_labels = ["__meta_docker_container_name"]
    regex         = "/(loki|grafana)"
    target_label  = "job"
    replacement   = "logging"
  }

  // Alloy itself (on all hosts)
  rule {
    source_labels = ["__meta_docker_container_name"]
    regex         = "/alloy"
    target_label  = "job"
    replacement   = "alloy"
  }
}

loki.source.docker "docker_logs" {
  host          = "unix:///var/run/docker.sock"
  targets       = discovery.docker.docker_containers.targets
  labels        = {
    job         = "docker",
    host        = "{{ inventory_hostname }}",
    environment = "production",
  }
  relabel_rules = loki.relabel.docker_relabel.rules
  forward_to    = [loki.process.docker_json.receiver]
}

// Parse Docker JSON logs
loki.process "docker_json" {
  forward_to = [loki.write.loki_backend.receiver]

  stage.json {
    expressions = {
      output = "log",
      stream = "stream",
      time   = "time",
    }
  }

  stage.labels {
    values = {
      stream = "",
    }
  }

  stage.output {
    source = "output"
  }
}
